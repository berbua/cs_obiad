// Simple Clippy.js wrapper for agents
(function() {
  window.clippy = {
    agents: {},
    
    load: function(name, callback) {
      var BASE_PATH = '/agents/';
      var agent = new Agent(BASE_PATH + name + '/', name);
      
      agent.load(function() {
        window.clippy.agents[name] = agent;
        if (callback) callback(agent);
      });
    }
  };
  
  function Agent(path, name) {
    this.path = path;
    this.name = name;
    this._data = null;
    this._el = null;
    this._animator = null;
    this._balloon = null;
    this._queue = [];
    this._isLoaded = false;
  }
  
  Agent.prototype.load = function(callback) {
    var self = this;
    
    $.getScript(this.path + 'agent.js', function() {
      self._data = window[self.name + 'AgentData'];
      self._setupElement();
      self._isLoaded = true;
      
      // Load sounds
      $.getScript(self.path + 'sounds-mp3.js', function() {
        if (callback) callback();
      });
    });
  };
  
  Agent.prototype._setupElement = function() {
    this._el = $('<div class="clippy-agent"></div>');
    this._el.css({
      position: 'fixed',
      bottom: '10px',
      right: '10px',
      width: '124px',
      height: '93px',
      backgroundImage: 'url(' + this.path + 'map.png)',
      backgroundRepeat: 'no-repeat',
      zIndex: 10000,
      cursor: 'pointer'
    });
    
    this._balloon = $('<div class="clippy-balloon"></div>');
    this._balloon.css({
      position: 'fixed',
      bottom: '110px',
      right: '10px',
      backgroundColor: '#FFFFCC',
      border: '2px solid #000',
      borderRadius: '5px',
      padding: '10px',
      maxWidth: '200px',
      display: 'none',
      zIndex: 10001,
      fontFamily: 'Comic Sans MS, cursive',
      fontSize: '12px',
      boxShadow: '2px 2px 5px rgba(0,0,0,0.3)'
    });
    
    $('body').append(this._el);
    $('body').append(this._balloon);
    
    this._currentFrame = 0;
    this._currentAnimation = null;
  };
  
  Agent.prototype.show = function() {
    if (this._el) {
      this._el.show();
    }
  };
  
  Agent.prototype.hide = function() {
    if (this._el) {
      this._el.hide();
    }
    if (this._balloon) {
      this._balloon.hide();
    }
  };
  
  Agent.prototype.speak = function(text) {
    var self = this;
    if (this._balloon) {
      this._balloon.text(text);
      this._balloon.fadeIn(300);
      
      setTimeout(function() {
        self._balloon.fadeOut(300);
      }, 3000 + (text.length * 30));
    }
  };
  
  Agent.prototype.play = function(animationName) {
    // Simple animation - just show/hide for now
    if (this._el) {
      this._el.addClass('clippy-animate');
      var self = this;
      setTimeout(function() {
        self._el.removeClass('clippy-animate');
      }, 1000);
    }
  };
  
  Agent.prototype.animate = function() {
    return this.play.apply(this, arguments);
  };
})();
