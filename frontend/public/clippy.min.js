// Simple Clippy.js wrapper for agents
(function() {
  window.clippy = {
    agents: {},
    
    load: function(name, callback) {
      var BASE_PATH = '/agents/';
      var agent = new Agent(BASE_PATH + name + '/', name);
      
      agent.load(function() {
        window.clippy.agents[name] = agent;
        if (callback) callback(agent);
      });
    }
  };
  
  function Agent(path, name) {
    this.path = path;
    this.name = name;
    this._data = null;
    this._el = null;
    this._animator = null;
    this._balloon = null;
    this._queue = [];
    this._isLoaded = false;
  }
  
  Agent.prototype.load = function(callback) {
    var self = this;
    
    $.getScript(this.path + 'agent.js', function() {
      self._data = window[self.name + 'AgentData'];
      self._setupElement();
      self._isLoaded = true;
      
      // Load sounds
      $.getScript(self.path + 'sounds-mp3.js', function() {
        if (callback) callback();
      });
    });
  };
  
  Agent.prototype._setupElement = function() {
    this._el = $('<div class="clippy-agent"></div>');
    this._el.css({
      position: 'fixed',
      bottom: '10px',
      right: '10px',
      width: '124px',
      height: '93px',
      backgroundImage: 'url(' + this.path + 'map.png)',
      backgroundRepeat: 'no-repeat',
      zIndex: 10000,
      cursor: 'pointer'
    });
    
    this._balloon = $('<div class="clippy-balloon"></div>');
    this._balloon.css({
      position: 'fixed',
      bottom: '110px',
      right: '10px',
      backgroundColor: '#FFFFCC',
      border: '2px solid #000',
      borderRadius: '5px',
      padding: '10px',
      maxWidth: '200px',
      display: 'none',
      zIndex: 10001,
      fontFamily: 'Comic Sans MS, cursive',
      fontSize: '12px',
      boxShadow: '2px 2px 5px rgba(0,0,0,0.3)'
    });
    
    // Random messages when clicked
    var messages = [
      'Hej! KliknÄ…Å‚eÅ› mnie! ğŸ“',
      'Witaj! Czy wiesz, Å¼e jestem klasycznym asystentem z MS Office? ğŸ“',
      'PamiÄ™tasz mnie z lat 90? Te czasy byÅ‚y wspaniaÅ‚e! ğŸŒŸ',
      'Potrzebujesz pomocy z czymÅ›? A moÅ¼e po prostu obiad? ğŸ•',
      'Jestem tu Å¼eby pomÃ³c! Albo przynajmniej siÄ™ staraÄ‡... ğŸ˜…',
      'Czy zapisaÅ‚eÅ› siÄ™ juÅ¼ na obiad? To waÅ¼ne! ğŸ”',
      'Kliknij przycisk z muzykÄ… - Nokia Tune to klasyka! ğŸµ',
      'PamiÄ™taj Å¼eby daÄ‡ lajka swoim kolegom! ğŸ‘',
      'Netscape Navigator 4.0 - to byÅ‚y czasy! ğŸŒ',
      'LubiÄ™ tÄ™ stronÄ™! Ma klimat vintage! âœ¨',
      'Czy prÃ³bowaÅ‚eÅ› juÅ¼ wszystkich funkcji? ğŸ¤”',
      'Jestem twÃ³j przyjaciel i asystentem! ğŸ¤',
      'Comic Sans to najlepszy font! Fight me! ğŸ˜¤',
      'WordArt + GIF-y = perfection! ğŸ’¯',
      'Czasami tÄ™skniÄ™ za Windows 98... ğŸ’™',
      'MiÄ™dzy nami - pilnujÄ™ teÅ¼ bezpieczeÅ„stwa! ğŸ”’',
      'PrÃ³bowaÅ‚eÅ› wpisaÄ‡ <script>? Nice try! ğŸ˜',
      'Jestem jak firewall, tylko przyjemniejszy! ğŸ›¡ï¸',
      'Hakerzy mnie nie lubiÄ…, ale ja ich pilnujÄ™! ğŸ‘€',
      'BezpieczeÅ„stwo to moja druga pasja po obiadach! ğŸš¨'
    ];
    
    var self = this;
    this._el.click(function() {
      var randomMessage = messages[Math.floor(Math.random() * messages.length)];
      self.speak(randomMessage);
      self.play('GetAttention');
    });
    
    $('body').append(this._el);
    $('body').append(this._balloon);
    
    this._currentFrame = 0;
    this._currentAnimation = null;
  };
  
  Agent.prototype.show = function() {
    if (this._el) {
      this._el.show();
    }
  };
  
  Agent.prototype.hide = function() {
    if (this._el) {
      this._el.hide();
    }
    if (this._balloon) {
      this._balloon.hide();
    }
  };
  
  Agent.prototype.speak = function(text) {
    var self = this;
    if (this._balloon) {
      this._balloon.text(text);
      this._balloon.fadeIn(300);
      
      setTimeout(function() {
        self._balloon.fadeOut(300);
      }, 3000 + (text.length * 30));
    }
  };
  
  Agent.prototype.play = function(animationName) {
    if (!this._el) return;
    
    // More frames for smoother animations
    var animations = {
      'Wave': { frames: [0, 0, 1, 1, 2, 2, 3, 3, 2, 2, 1, 1, 0, 0], duration: 1400 },
      'GetAttention': { frames: [0, 14, 14, 15, 15, 14, 14, 0, 14, 14, 0], duration: 1100 },
      'Congratulate': { frames: [0, 0, 12, 12, 13, 13, 12, 12, 13, 13, 12, 12, 0, 0], duration: 1600 },
      'GetTechy': { frames: [0, 0, 21, 21, 22, 22, 23, 23, 22, 22, 21, 21, 0, 0], duration: 1400 },
      'Sad': { frames: [0, 0, 28, 28, 29, 29, 29, 29, 28, 28, 0, 0], duration: 1600 },
      'Thinking': { frames: [0, 0, 30, 30, 31, 31, 30, 30, 31, 31, 30, 30, 0, 0], duration: 1400 },
      'LookDown': { frames: [0, 0, 15, 15, 15, 15, 0, 0], duration: 1000 },
      'LookUp': { frames: [0, 0, 16, 16, 16, 16, 0, 0], duration: 1000 },
      'LookLeft': { frames: [0, 0, 17, 17, 17, 17, 0, 0], duration: 1000 },
      'LookRight': { frames: [0, 0, 18, 18, 18, 18, 0, 0], duration: 1000 },
      'Reading': { frames: [0, 0, 19, 19, 20, 20, 19, 19, 20, 20, 19, 19, 0, 0], duration: 1400 },
      'Writing': { frames: [0, 0, 23, 23, 24, 24, 23, 23, 24, 24, 23, 23, 0, 0], duration: 1400 },
      'GetWizardy': { frames: [0, 0, 25, 25, 26, 26, 25, 25, 26, 26, 25, 25, 0, 0], duration: 1400 },
      'CheckingSomething': { frames: [0, 0, 27, 27, 27, 27, 0, 0], duration: 1100 },
      'Searching': { frames: [0, 0, 32, 32, 33, 33, 32, 32, 33, 33, 32, 32, 0, 0], duration: 1400 },
      'RestPose': { frames: [0], duration: 500 },
      'Alert': { frames: [0, 14, 0, 14, 0], duration: 700 }
    };
    
    var animation = animations[animationName] || animations['Wave'];
    var self = this;
    var frameIndex = 0;
    
    // Add CSS animation class for extra movement
    var animClass = 'clippy-animate-' + animationName.toLowerCase();
    this._el.addClass(animClass);
    
    var frameDelay = animation.duration / animation.frames.length;
    
    var animateFrames = function() {
      if (frameIndex < animation.frames.length) {
        var frame = animation.frames[frameIndex];
        var x = (frame % 10) * -124;
        var y = Math.floor(frame / 10) * -93;
        
        // No CSS transition - instant frame change for sprite animation
        self._el.css({
          backgroundPosition: x + 'px ' + y + 'px',
          transition: 'none'
        });
        
        frameIndex++;
        setTimeout(animateFrames, frameDelay);
      } else {
        // Reset to default pose
        self._el.css({
          backgroundPosition: '0px 0px'
        });
        setTimeout(function() {
          self._el.removeClass(animClass);
        }, 100);
      }
    };
    
    animateFrames();
  };
  
  Agent.prototype.animate = function() {
    return this.play.apply(this, arguments);
  };
})();
